#!/usr/bin/env bash
set -euo pipefail

# 1) Write the exact Kotlin source you supplied ------------------------------
cat > "Journey.kt" <<'EOF'
import jetbrains.buildServer.configs.kotlin.*

object Journey_%env.JOURNEY_NAME% : BuildType({
    name = "%env.JOURNEY_NAME%"

    templates(JourneyExecutorTemplate)
})
EOF

b64=$(base64 < Journey.kt | tr -d '\n')

# 3) Build the JSON request ---------------------------------------------------
payload=$(cat <<EOF
{
  "message": "Add Journey_${JOURNEY_NAME}.kt",
  "branch": "main",
  "content": "${b64}"
}
EOF
)

# 4) Upload (create or update) the file on GitHub ----------------------------
curl -f -s \
-X PUT \
-H "Authorization: Bearer ${GIT_PAT_TOKEN}" \
-H "Content-Type: application/json" \
--data "${payload}" \
"https://api.github.com/repos/ChiriacCasian/TeamCityBuildServer/contents/.teamcity/Journey_${JOURNEY_NAME}.kt"

echo "âœ… uploaded successfully"